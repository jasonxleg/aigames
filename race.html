<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>音速衝刺 HTML版</title>
    <style>
        /* --- 基礎設定 --- */
        :root {
            --sky-color: #87CEEB;
            --grass-color: #00aa00;
            --sonic-blue: #2980b9;
        }

        html, body {
            margin: 0; padding: 0;
            width: 100%; height: 100dvh;
            background-color: var(--sky-color);
            overflow: hidden;
            font-family: 'Verdana', sans-serif;
            touch-action: none;
            user-select: none; -webkit-user-select: none;
        }

        /* --- 遊戲容器與背景 --- */
        #game-container {
            position: relative;
            width: 100%; max-width: 480px; height: 100%;
            margin: 0 auto;
            background: linear-gradient(to bottom, #87CEEB 0%, #bffff6 50%, #006400 50%, #004400 100%);
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* 偽 3D 棋盤格地板 (透視感) */
        #ground-grid {
            position: absolute;
            bottom: 0; left: -50%; width: 200%; height: 50%;
            background-image: 
                linear-gradient(90deg, rgba(255,255,255,0.2) 2px, transparent 2px),
                linear-gradient(0deg, rgba(255,255,255,0.2) 2px, transparent 2px);
            background-size: 100px 100px;
            transform-origin: 50% 0%;
            transform: perspective(300px) rotateX(60deg);
            z-index: 0;
        }

        /* --- 遊戲物件 --- */
        
        /* 音速小子 (滾動衝刺狀態) */
        #player {
            position: absolute;
            bottom: 80px; left: 50%;
            width: 50px; height: 50px;
            background: radial-gradient(circle at 30% 30%, #3498db, #00008B);
            border-radius: 50%;
            box-shadow: 0 0 15px #3498db;
            z-index: 20;
            transform: translateX(-50%);
            transition: left 0.08s linear;
        }
        /* 刺蝟的刺 (旋轉動畫) */
        #player::after {
            content: ''; position: absolute; top: -5px; left: -5px; right: -5px; bottom: -5px;
            border: 4px dashed rgba(255,255,255,0.6);
            border-radius: 50%;
            animation: spin 0.2s linear infinite;
        }

        /* 敵人 (螃蟹機器人風格) */
        .enemy {
            position: absolute;
            width: 50px; height: 40px;
            background: #e74c3c; /* 紅色 */
            border-radius: 10px 10px 5px 5px;
            border-bottom: 5px solid #333;
            z-index: 10;
            display: flex; justify-content: center;
        }
        /* 眼睛 */
        .enemy::before {
            content: ''; position: absolute; top: 10px; width: 30px; height: 10px;
            background: #fff; border-radius: 5px;
            box-shadow: inset 10px 0 0 #000; /* 瞳孔 */
        }
        /* 爪子 */
        .enemy::after {
            content: ''; position: absolute; top: -10px; width: 100%; height: 10px;
            border-left: 5px solid #c0392b; border-right: 5px solid #c0392b;
        }

        /* 金環 */
        .ring {
            position: absolute;
            width: 30px; height: 30px;
            border: 4px solid #f1c40f;
            border-radius: 50%;
            box-shadow: 0 0 5px #f1c40f, inset 0 0 5px #f1c40f;
            z-index: 9;
            animation: ringSpin 1s infinite linear;
        }

        /* --- UI 與 特效 --- */
        
        /* 資訊欄 (HUD) */
        #hud {
            position: absolute; top: 10px; left: 10px;
            font-family: 'Courier New', monospace;
            font-weight: bold; font-style: italic;
            color: #f1c40f; text-shadow: 2px 2px #000;
            z-index: 50; font-size: 20px;
            pointer-events: none;
        }
        
        .hud-row { margin-bottom: 5px; }
        .red-text { color: #e74c3c !important; animation: blink 0.2s infinite; }

        /* 受傷閃爍層 */
        #flash-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; opacity: 0; pointer-events: none; z-index: 90;
        }

        /* 選單介面 */
        #menu-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 200;
        }

        h1 {
            color: #3498db; font-size: 40px; margin-bottom: 0;
            text-transform: uppercase; font-style: italic;
            text-shadow: 4px 4px #e74c3c;
            transform: skew(-10deg);
        }

        button {
            background: #f1c40f; color: #000;
            border: 4px solid #fff;
            padding: 15px 50px; font-size: 24px; font-weight: bold; font-style: italic;
            border-radius: 50px; cursor: pointer; margin-top: 30px;
            box-shadow: 0 5px 0 #c27c0e;
            pointer-events: auto; touch-action: manipulation;
        }
        button:active { transform: translateY(4px); box-shadow: none; }

        /* 隱形觸控區 */
        .touch-zone {
            position: absolute; top: 0; height: 100%; width: 50%;
            z-index: 100; display: none; /* 遊戲開始才顯示 */
        }
        #t-left { left: 0; }
        #t-right { right: 0; }

        /* --- 動畫 --- */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes ringSpin { 0% { transform: scaleX(1); } 50% { transform: scaleX(0.2); } 100% { transform: scaleX(1); } }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    </style>
</head>
<body>

    <div id="game-container">
        <div id="ground-grid"></div>

        <div id="player"></div>
        
        <div id="hud">
            <div class="hud-row">SCORE: <span id="score-val">0</span></div>
            <div class="hud-row" id="ring-box">RINGS: <span id="rings-val">0</span></div>
        </div>

        <div id="flash-screen"></div>

        <div id="t-left" class="touch-zone"></div>
        <div id="t-right" class="touch-zone"></div>

        <div id="menu-screen">
            <h1>SONIC<br>RUSH</h1>
            <p id="final-msg" style="color:white; margin-top:10px; display:none;">GAME OVER</p>
            <button id="start-btn">START</button>
            <div style="color:#ccc; margin-top:20px; font-size:12px; text-align:center;">
                點擊左側 ← 移動 → 點擊右側<br>
                <span style="color:#f1c40f">收集金環來抵擋傷害!</span>
            </div>
        </div>
    </div>

    <script>
        // --- 變數宣告 ---
        const player = document.getElementById('player');
        const container = document.getElementById('game-container');
        const ground = document.getElementById('ground-grid');
        const menu = document.getElementById('menu-screen');
        const scoreEl = document.getElementById('score-val');
        const ringsEl = document.getElementById('rings-val');
        const ringBox = document.getElementById('ring-box');
        const flashScreen = document.getElementById('flash-screen');
        const finalMsg = document.getElementById('final-msg');
        
        let isRunning = false;
        let score = 0;
        let rings = 0;
        let speed = 8;
        let playerX = 50;
        let invulnerable = false; // 無敵時間
        
        let items = []; // 包含敵人和金環
        let animationId;
        
        // 控制變數
        let keys = { left: false, right: false };

        // --- 遊戲初始化 ---
        function init() {
            // 清理場景
            document.querySelectorAll('.enemy, .ring').forEach(e => e.remove());
            items = [];
            
            score = 0;
            rings = 0; // 初始 0 環
            speed = 8;
            playerX = 50;
            player.style.opacity = '1';
            
            updateUI();
            
            menu.style.display = 'none';
            document.getElementById('t-left').style.display = 'block';
            document.getElementById('t-right').style.display = 'block';
            
            isRunning = true;
            animationId = requestAnimationFrame(gameLoop);
        }

        // --- 核心迴圈 ---
        function gameLoop() {
            if(!isRunning) return;

            // 1. 玩家移動
            if(keys.left && playerX > 10) playerX -= 2.5;
            if(keys.right && playerX < 90) playerX += 2.5;
            player.style.left = `${playerX}%`;

            // 2. 地板移動效果 (增加速度感)
            let groundY = (Date.now() * (speed / 10)) % 100;
            ground.style.backgroundPosition = `0px ${groundY}px`;

            // 3. 物件生成與移動
            manageItems();

            // 4. 分數
            score++;
            if(score % 600 === 0) speed += 1; // 加速
            updateUI();

            animationId = requestAnimationFrame(gameLoop);
        }

        // --- 物件管理 (金環與敵人) ---
        function manageItems() {
            // 生成 (隨機決定是敵人還是金環)
            if(Math.random() < 0.03) {
                // 70% 機率是金環，30% 是敵人
                let isEnemy = Math.random() > 0.7;
                createItem(isEnemy);
            }

            items.forEach((item, index) => {
                let y = parseFloat(item.el.style.top);
                y += speed;
                item.el.style.top = y + 'px';

                // 碰撞檢測
                if(checkCollision(player, item.el)) {
                    if(item.type === 'enemy') {
                        hitEnemy();
                    } else {
                        collectRing(item.el, index);
                    }
                }

                // 移除超出畫面的
                if(y > container.offsetHeight) {
                    item.el.remove();
                    items.splice(index, 1);
                }
            });
        }

        function createItem(isEnemy) {
            let el = document.createElement('div');
            let lane = [20, 50, 80][Math.floor(Math.random()*3)];
            
            // 避免重疊太近，簡單處理
            if(items.length > 0) {
                let last = items[items.length-1];
                if(parseFloat(last.el.style.top) < 100) return; 
            }

            el.style.left = `calc(${lane}% - ${isEnemy ? 25 : 15}px)`;
            el.style.top = '-100px';
            
            if(isEnemy) {
                el.className = 'enemy';
            } else {
                el.className = 'ring';
            }
            
            container.appendChild(el);
            items.push({ el: el, type: isEnemy ? 'enemy' : 'ring' });
        }

        // --- 遊戲邏輯 (音速小子機制) ---

        function collectRing(el, index) {
            rings++;
            el.remove();
            items.splice(index, 1);
            // 簡單的音效替代品：視覺放大
            ringsEl.style.transform = "scale(1.5)";
            setTimeout(() => ringsEl.style.transform = "scale(1)", 100);
        }

        function hitEnemy() {
            if(invulnerable) return; // 無敵中

            if(rings > 0) {
                // 有環：噴環機制
                rings = 0;
                invulnerable = true;
                player.style.opacity = '0.5';
                ringBox.classList.add('red-text'); // 紅字警告
                
                // 畫面閃爍
                flashScreen.style.opacity = '0.8';
                setTimeout(() => flashScreen.style.opacity = '0', 100);

                // 2秒後解除無敵
                setTimeout(() => {
                    invulnerable = false;
                    player.style.opacity = '1';
                    ringBox.classList.remove('red-text');
                }, 2000);
            } else {
                // 沒環：Game Over
                gameOver();
            }
        }

        function gameOver() {
            isRunning = false;
            cancelAnimationFrame(animationId);
            
            finalMsg.innerText = `GAME OVER\nSCORE: ${Math.floor(score/10)}`;
            finalMsg.style.display = 'block';
            menu.style.display = 'flex';
            
            document.getElementById('t-left').style.display = 'none';
            document.getElementById('t-right').style.display = 'none';
        }

        function checkCollision(a, b) {
            if (b.style.display === 'none') return false;
            let rect1 = a.getBoundingClientRect();
            let rect2 = b.getBoundingClientRect();
            // 縮小碰撞箱讓手感更好
            return !(rect1.bottom - 10 < rect2.top || 
                     rect1.top + 10 > rect2.bottom || 
                     rect1.right - 10 < rect2.left || 
                     rect1.left + 10 > rect2.right);
        }

        function updateUI() {
            scoreEl.innerText = Math.floor(score/10);
            ringsEl.innerText = rings;
        }

        // --- 輸入控制 (iPhone 優化) ---

        const btn = document.getElementById('start-btn');
        btn.addEventListener('click', init);

        // 鍵盤
        document.addEventListener('keydown', e => {
            if(e.key === 'ArrowLeft') keys.left = true;
            if(e.key === 'ArrowRight') keys.right = true;
        });
        document.addEventListener('keyup', e => {
            if(e.key === 'ArrowLeft') keys.left = false;
            if(e.key === 'ArrowRight') keys.right = false;
        });

        // 觸控
        const handleTouch = (side, active) => {
            if(side === 'left') keys.left = active;
            if(side === 'right') keys.right = active;
        };

        const tLeft = document.getElementById('t-left');
        const tRight = document.getElementById('t-right');

        tLeft.addEventListener('touchstart', (e) => { e.preventDefault(); handleTouch('left', true); });
        tLeft.addEventListener('touchend', (e) => { e.preventDefault(); handleTouch('left', false); });
        
        tRight.addEventListener('touchstart', (e) => { e.preventDefault(); handleTouch('right', true); });
        tRight.addEventListener('touchend', (e) => { e.preventDefault(); handleTouch('right', false); });

    </script>
</body>
</html>
