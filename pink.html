<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>憤怒的大叔 V.S. 頑皮豹</title>
    <style>
        /* --- 全局與響應式設定 --- */
        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background-color: #f0e68c;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            box-sizing: border-box;
            touch-action: none; /* 禁止瀏覽器預設的捲動和縮放，這對拖曳遊戲很重要 */
            overflow: hidden; /* 防止捲軸出現 */
        }

        h1 {
            color: #d43f3a; /* 憤怒的紅色 */
            text-shadow: 2px 2px 0px #000;
            font-size: clamp(1.2rem, 4vw, 2rem);
            margin: 5px 0;
            text-align: center;
        }

        /* --- 遊戲主容器 --- */
        #game-container {
            width: 100%;
            max-width: 800px;
            aspect-ratio: 16 / 9; /* 改用更寬的比例適合彈射 */
            background-color: #ffcc00;
            border: 3px solid #000;
            position: relative;
            overflow: hidden;
            /* 炎熱的城市背景漸層 */
            background-image: linear-gradient(to bottom, #ff9966 0%, #ffcc00 70%, #e6b800 70%);
            box-shadow: 5px 5px 0px rgba(0,0,0,0.2);
            margin: auto;
            user-select: none;
        }

        /* 地面裝飾線 */
        .ground-line {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 25%; /* 調整地面高度 */
            background-color: #c2a35f; /* 泥土/柏油路色 */
            border-top: 3px solid #000;
            z-index: 0;
        }

        /* --- 遊戲角色與 Sprite --- */
        .sprite {
            background-size: 200% 200%; /* 2x2 格子圖 */
            position: absolute;
            background-repeat: no-repeat;
        }

        /* 彈射物：憤怒大叔 */
        #projectile-man {
            width: 15%; /* 相對容器寬度 */
            aspect-ratio: 1 / 1; /* 保持正方形 */
            background-position: 15% 25%; /* 取左上角的圖 */
            bottom: 28%; /* 放在地面上方一點 */
            left: 15%;   /* 發射起始位置 */
            z-index: 2;
            cursor: grab;
            /* 碰撞箱稍微小一點 */
            clip-path: circle(45% at 50% 50%);
        }
        #projectile-man.grabbing {
            cursor: grabbing;
        }

        /* 目標：頑皮豹 */
        #target-panther {
            width: 18%;
            aspect-ratio: 0.8 / 1; /* 稍微瘦長 */
            background-position: 85% 20%; /* 取右上角的圖 */
            bottom: 25%;
            right: 10%; /* 放在右側 */
            z-index: 1;
        }
        
        /* 彈弓的視覺錨點 (一個簡單的柱子) */
        .slingshot-anchor {
            position: absolute;
            width: 10px;
            height: 60px;
            background-color: #5d4037;
            bottom: 25%;
            left: calc(15% + 7.5%); /* 對齊男人中心 */
            z-index: 1;
            border: 2px solid #3e2723;
        }

        /* --- 瞄準線 (SVG) --- */
        #trajectory-svg {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none; /* 不干擾點擊 */
            z-index: 0;
        }
        #aim-line {
            stroke: rgba(255, 255, 255, 0.7);
            stroke-width: 4;
            stroke-dasharray: 10, 5; /* 虛線 */
            display: none; /* 預設隱藏 */
        }

        /* --- UI 與結果介面 --- */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0,0,0,0.5);
            z-index: 10;
            color: white;
            text-align: center;
        }
        
        #result-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20;
            display: none;
            background-color: rgba(0,0,0,0.8);
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }

        /* 勝利時顯示的圖片 (撞牆圖) */
        #win-image {
            width: 60%;
            aspect-ratio: 16/9;
            background-position: 100% 100%; /* 取右下角的圖 */
            background-size: 200% 200%;
            border: 3px solid white;
            margin-bottom: 20px;
            display: none;
        }

        button {
            padding: 12px 24px;
            font-size: 1.2rem;
            background-color: #d43f3a;
            border: 3px solid #000;
            color: white;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 3px 3px 0px #000;
        }
        button:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0px #000; }

        #instructions {
            font-size: 1.1rem;
            background: rgba(255,255,255,0.9);
            color: black;
            padding: 15px;
            border: 3px solid black;
            width: 80%;
            max-width: 400px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <h1>憤怒的大叔 V.S. 頑皮豹</h1>

    <div id="game-container">
        <div class="ground-line"></div>
        <div class="slingshot-anchor"></div>
        
        <svg id="trajectory-svg">
            <line id="aim-line" x1="0" y1="0" x2="0" y2="0" />
        </svg>

        <div id="target-panther" class="sprite"></div>
        <div id="projectile-man" class="sprite"></div>
        
        <div id="ui-layer">
            <div id="instructions">
                <p>目標：用大叔撞飛頑皮豹！</p>
                <p><strong>按住大叔向後拖曳</strong></p>
                <p>瞄準後放開射擊！</p>
            </div>
            <button id="start-btn">開始遊戲</button>
        </div>

        <div id="result-overlay">
            <h2 id="result-text">結果</h2>
            <div id="win-image" class="sprite"></div>
            <button id="restart-btn">再玩一次</button>
        </div>
    </div>

    <script>
        // --- 變數設定 ---
        const container = document.getElementById('game-container');
        const man = document.getElementById('projectile-man');
        const panther = document.getElementById('target-panther');
        const aimLine = document.getElementById('aim-line');
        const uiLayer = document.getElementById('ui-layer');
        const resultOverlay = document.getElementById('result-overlay');
        const resultText = document.getElementById('result-text');
        const winImage = document.getElementById('win-image');

        // 圖片連結
        const yourImageURL = 'https://raw.githubusercontent.com/jasonxleg/aigames/main/pinker.jpg';

        // 物理參數
        let gameState = 'start'; // start, aiming, flying, ended
        let startPos = { x: 0, y: 0 }; // 彈射起始點 (大叔的初始中心位置)
        let currentPos = { x: 0, y: 0 }; // 拖曳時的位置
        let velocity = { x: 0, y: 0 };   // 飛行速度
        const gravity = 0.6;             // 重力加速度
        const powerMultiplier = 0.15;     // 拉力轉換為速度的倍率
        const maxPullDistance = 150;     // 最大拖曳距離限制
        let animationFrameId;

        // --- 初始化與圖片載入 ---
        function init() {
            applyImageToSprites();
            resetGame();
            
            document.getElementById('start-btn').addEventListener('click', () => {
                uiLayer.style.display = 'none';
                gameState = 'ready';
            });
            document.getElementById('restart-btn').addEventListener('click', resetGame);
            
            setupInputHandlers();
        }

        function applyImageToSprites() {
            document.querySelectorAll('.sprite').forEach(el => {
                el.style.backgroundImage = `url('${yourImageURL}')`;
            });
        }

        // 獲取元素的中心點座標 (相對於遊戲容器)
        function getCenter(element) {
            const rect = element.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            return {
                x: rect.left + rect.width / 2 - containerRect.left,
                y: rect.top + rect.height / 2 - containerRect.top
            };
        }

        function resetGame() {
            gameState = 'start';
            uiLayer.style.display = 'flex';
            resultOverlay.style.display = 'none';
            winImage.style.display = 'none';
            aimLine.style.display = 'none';
            
            // 重置位置 CSS
            man.style.left = '15%';
            man.style.bottom = '28%';
            man.style.transform = 'translate(0, 0) rotate(0deg)';
            panther.style.display = 'block'; // 確保豹顯示
            
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            
            // 等待瀏覽器佈局完成後，抓取準確的起始中心點
            setTimeout(() => {
                startPos = getCenter(man);
            }, 100);
        }

        // --- 輸入事件處理 (滑鼠與觸控) ---
        function setupInputHandlers() {
            // 開始拖曳
            man.addEventListener('mousedown', onDragStart);
            man.addEventListener('touchstart', onDragStart, { passive: false });

            // 拖曳中 (綁定在 document 上以防止滑出範圍)
            document.addEventListener('mousemove', onDragMove);
            document.addEventListener('touchmove', onDragMove, { passive: false });

            // 結束拖曳
            document.addEventListener('mouseup', onDragEnd);
            document.addEventListener('touchend', onDragEnd);
        }

        function getEventPos(e) {
            const containerRect = container.getBoundingClientRect();
            let clientX, clientY;
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            return {
                x: clientX - containerRect.left,
                y: clientY - containerRect.top
            };
        }

        function onDragStart(e) {
            if (gameState !== 'ready') return;
            if (e.type === 'touchstart') e.preventDefault();
            gameState = 'aiming';
            man.classList.add('grabbing');
            aimLine.style.display = 'block';
            currentPos = getCenter(man); // 初始位置
        }

        function onDragMove(e) {
            if (gameState !== 'aiming') return;
            if (e.type === 'touchmove') e.preventDefault();

            let mousePos = getEventPos(e);
            
            // 計算拉動向量 (從滑鼠指向起始點，因為是向後拉)
            let dragVector = {
                x: startPos.x - mousePos.x,
                y: startPos.y - mousePos.y
            };

            // 限制最大拉動距離
            let distance = Math.sqrt(dragVector.x * dragVector.x + dragVector.y * dragVector.y);
            if (distance > maxPullDistance) {
                let ratio = maxPullDistance / distance;
                dragVector.x *= ratio;
                dragVector.y *= ratio;
                mousePos.x = startPos.x - dragVector.x;
                mousePos.y = startPos.y - dragVector.y;
            }
            
            currentPos = mousePos;

            // 更新大叔的位置 (視覺上跟隨拖曳)
            // 使用 transform 來移動，避免改變 layout
            const deltaX = currentPos.x - startPos.x;
            const deltaY = currentPos.y - startPos.y;
            man.style.transform = `translate(${deltaX}px, ${deltaY}px)`;

            // 更新瞄準線
            aimLine.setAttribute('x1', startPos.x);
            aimLine.setAttribute('y1', startPos.y);
            aimLine.setAttribute('x2', currentPos.x);
            aimLine.setAttribute('y2', currentPos.y);
        }

        function onDragEnd(e) {
            if (gameState !== 'aiming') return;
            gameState = 'flying';
            man.classList.remove('grabbing');
            aimLine.style.display = 'none';

            // 計算發射速度 (拉動向量 * 倍率)
            // 向量是從現在位置指向起始位置
            velocity.x = (startPos.x - currentPos.x) * powerMultiplier;
            velocity.y = (startPos.y - currentPos.y) * powerMultiplier;

            // 確保是向右發射 (防止向前拉也能發射)
            if (velocity.x < 0) velocity.x = 1; 

            gameLoop();
        }

        // --- 遊戲主迴圈 (物理飛行) ---
        function gameLoop() {
            if (gameState !== 'flying') return;

            // 1. 應用重力
            velocity.y += gravity;

            // 2. 更新位置
            // 我們需要獲取當前的 translate 值來疊加
            const style = window.getComputedStyle(man);
            const matrix = new DOMMatrix(style.transform);
            let newX = matrix.m41 + velocity.x;
            let newY = matrix.m42 + velocity.y;

            // 簡單的旋轉效果
            let rotation = Math.atan2(velocity.y, velocity.x) * (180 / Math.PI);
            man.style.transform = `translate(${newX}px, ${newY}px) rotate(${rotation}deg)`;

            // 3. 碰撞檢測
            const manRect = man.getBoundingClientRect();
            const pantherRect = panther.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();

            // 檢查是否撞到頑皮豹 (簡單矩形碰撞)
            if (manRect.right > pantherRect.left + 20 && // +20 稍微縮小判定範圍
                manRect.left < pantherRect.right - 20 &&
                manRect.bottom > pantherRect.top + 20 &&
                manRect.top < pantherRect.bottom - 20) {
                endGame(true);
                return;
            }

            // 檢查是否落地或飛出邊界
            // 地面高度約為容器高度的 75% 處
            if (manRect.bottom > containerRect.bottom - (containerRect.height * 0.25) + 10 ||
                manRect.left > containerRect.right ||
                manRect.right < containerRect.left ||
                manRect.top > containerRect.bottom) {
                
                // 簡單的落地滾動效果，然後結束
                if (velocity.y > 0 && manRect.bottom > containerRect.bottom - (containerRect.height * 0.25)) {
                     velocity.y = -velocity.y * 0.5; // 彈跳
                     velocity.x *= 0.8; // 摩擦力
                     if (Math.abs(velocity.y) < 1 && Math.abs(velocity.x) < 1) {
                          endGame(false);
                          return;
                     }
                } else {
                   endGame(false);
                   return;
                }
            }

            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // --- 遊戲結束處理 ---
        function endGame(success) {
            gameState = 'ended';
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            
            setTimeout(() => {
                resultOverlay.style.display = 'flex';
                if (success) {
                    resultText.textContent = "成功擊中！大叔復仇成功！";
                    resultText.style.color = "#5cb85c"; // 綠色
                    panther.style.display = 'none'; // 隱藏被打到的豹
                    winImage.style.display = 'block'; // 顯示漫畫第四格
                } else {
                    resultText.textContent = "失敗... 沒打中";
                    resultText.style.color = "#d43f3a"; // 紅色
                }
            }, 500); // 稍等一下再顯示結果
        }

        // 啟動遊戲
        init();

    </script>
</body>
</html>
